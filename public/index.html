<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Unturned Inventory DB</title>
  <style>
    body{background:#0f0f10;color:#eee;font-family:Arial,Helvetica,sans-serif;margin:0}
    .top{padding:12px 16px;background:#111;display:flex;align-items:center;gap:12px}
    .tabs{display:flex;gap:12px}
    .tab{padding:8px 12px;cursor:pointer;color:#bbb}
    .tab.active{color:#fff;border-bottom:3px solid #32cd32}
    .search{margin:12px;padding:8px}
    input[type=text]{padding:8px;border:1px solid #333;background:#121212;color:#fff}
    button{padding:8px 10px;background:#32cd32;border:none;color:#062706;cursor:pointer}
    .container{padding:16px}
    .grid{display:flex;flex-wrap:wrap;gap:10px}
    .card{width:100px;height:120px;background:#1b1b1b;padding:6px;border-radius:6px}
    .muted{color:#aaa;font-size:0.9rem}
  </style>
</head>
<body>
  <div class="top">
    <div style="font-weight:700">Unturned Inventory DB</div>
    <div class="tabs">
      <div class="tab active" data-tab="info">Info</div>
      <div class="tab" data-tab="leaderboard">Leaderboard</div>
      <div class="tab" data-tab="add">Add Inventory</div>
      <div class="tab" data-tab="discord">Discord</div>
    </div>
  </div>

  <div style="padding:12px;text-align:center">
    <input id="globalSearch" type="text" placeholder="Search skins across DB..." style="width:60%;padding:8px">
  </div>

  <div class="container">
    <div id="info" class="panel"> <h2>Info</h2>
      <p class="muted">This demo fetches Unturned inventories from Steam and stores them server-side. Prices may not be accurate due to regional differences, Steam delays, and low-sale history.</p>
    </div>

    <div id="leaderboard" class="panel" style="display:none">
      <h2>Leaderboard (stored inventories)</h2>
      <div><button id="refreshInv">Refresh list</button></div>
      <div id="invList" style="margin-top:12px"></div>
      <div id="itemsArea" style="margin-top:12px"></div>
    </div>

    <div id="add" class="panel" style="display:none">
      <h2>Add Inventory</h2>
      <div>
        <input id="steamInput" type="text" placeholder="Enter SteamID64" />
        <button id="fetchBtn">Fetch & Save</button>
      </div>
      <div id="status" style="margin-top:8px"></div>
    </div>

    <div id="discord" class="panel" style="display:none">
      <h2>Discord</h2>
      <a href="https://discord.gg/jmd4qzD4JF" target="_blank">Join Discord</a>
    </div>
  </div>

  <script>
    // tabs
    document.querySelectorAll('.tab').forEach(t => {
      t.onclick = () => {
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        t.classList.add('active');
        const tab = t.dataset.tab;
        ['info','leaderboard','add','discord'].forEach(id => document.getElementById(id).style.display = (id===tab?'block':'none'));
        if (tab==='leaderboard') loadInventories();
      };
    });

    const apiBase = window.location.origin;

    async function loadInventories(){
      const el = document.getElementById('invList');
      el.innerHTML = 'Loading...';
      try {
        const res = await fetch(apiBase + '/api/inventories');
        const list = await res.json();
        if (!list.length) { el.innerHTML = '<div>No saved inventories yet.</div>'; return; }
        el.innerHTML = '<ul>' + list.map(i => `<li><a href="#" data-id="${i.id}" class="invLink">${i.steamid}</a> (items view)</li>`).join('') + '</ul>';
        document.querySelectorAll('.invLink').forEach(a=>{
          a.onclick = async (e)=>{
            e.preventDefault();
            const id = a.dataset.id;
            const itemsArea = document.getElementById('itemsArea');
            itemsArea.innerHTML = 'Loading items...';
            const r = await fetch(apiBase + '/api/inventories/' + id + '/items');
            const items = await r.json();
            if (!items.length) { itemsArea.innerHTML = 'No items'; return; }
            itemsArea.innerHTML = '<div class="grid">' + items.slice(0,200).map(it => `<div class="card"><img src="${it.icon_url||'https://placehold.co/80x80?text=?'}" style="width:80px;height:80px"><div style="font-size:12px">${it.market_hash_name||it.name||'Unknown'}</div></div>`).join('') + '</div>';
          };
        });
      } catch (err) { el.innerHTML = 'Error loading inventories'; console.error(err); }
    }

    // fetch & save inventory
    document.getElementById('fetchBtn').addEventListener('click', async ()=>{
      const steam = document.getElementById('steamInput').value.trim();
      const status = document.getElementById('status');
      if (!steam) return status.textContent = 'Enter SteamID';
      status.textContent = 'Fetching...';
      try {
        const res = await fetch(apiBase + '/api/fetch', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ steamid: steam }) });
        const j = await res.json();
        if (res.ok) status.textContent = `Saved inventory ID ${j.inventoryId} (${j.assets} assets)`;
        else status.textContent = 'Failed: ' + (j.error||JSON.stringify(j));
      } catch (err) { status.textContent = 'Fetch error'; console.error(err); }
    });

    // global search (client-side filtering of currently shown items)
    document.getElementById('globalSearch').addEventListener('input', async (e) => {
      const q = e.target.value.trim();
      if (!q) return;
      try {
        const res = await fetch(apiBase + '/api/search?q=' + encodeURIComponent(q));
        const rows = await res.json();
        const area = document.getElementById('itemsArea');
        if (!rows.length) { area.innerHTML = 'No results'; return; }
        area.innerHTML = '<div class="grid">' + rows.slice(0,200).map(it => `<div class="card"><img src="${it.icon_url||'https://placehold.co/80x80?text=?'}" style="width:80px;height:80px"><div style="font-size:12px">${it.market_hash_name||it.name||'Unknown'}</div></div>`).join('') + '</div>';
      } catch (err) { console.error(err); }
    });

    // init
    // loadInventories(); // lazy: load when leaderboard tab clicked
  </script>
</body>
</html>
